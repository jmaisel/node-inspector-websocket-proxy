<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protocol Runner - Console Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background-color: #1e1e1e;
      color: #d4d4d4;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #4ec9b0;
      font-size: 18px;
      margin: 0 0 10px 0;
    }
    p {
      margin: 5px 0;
      font-size: 14px;
      color: #858585;
    }
    .button-container {
      margin: 20px 0;
    }
    button {
      background-color: #0e639c;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }
    button:hover {
      background-color: #1177bb;
    }
    button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      background-color: #2d2d2d;
      border-left: 3px solid #4ec9b0;
      border-radius: 4px;
    }
    .error {
      border-left-color: #f48771;
    }
    .success {
      border-left-color: #89d185;
    }
    .event {
      border-left-color: #ce9178;
    }
    #event-log {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      background-color: #1e1e1e;
      border: 1px solid #3e3e3e;
      padding: 10px;
      border-radius: 4px;
    }
    .log-entry {
      padding: 5px;
      margin: 2px 0;
      font-size: 12px;
      background-color: #252526;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <h1>Protocol Runner - Console Event Test</h1>
  <p>Testing Console controller with static WebsocketProtocolEventQueue</p>
  <p>The busy-script.js logs every 10000 iterations - you should see events below</p>

  <div class="button-container">
    <button id="initBtn" onclick="initializeAndSubscribe()">1. Initialize & Subscribe to Console Events</button>
    <button id="enableBtn" onclick="enableConsole()">2. Enable Console Domain</button>
  </div>

  <div id="status-container"></div>

  <h2 style="color: #ce9178; font-size: 16px; margin-top: 20px;">Console Events:</h2>
  <div id="event-log"></div>

  <!-- Load dependencies -->
  <script src="./regex-pubsub.js"></script>
  <script src="./inspector-constants.js"></script>
  <script src="./websocket-protocol-event-queue.js"></script>
  <script src="./inspector-controllers.js"></script>

  <script>
    let isInitialized = false;
    let eventQueue = null;
    let eventCount = 0;

    async function initializeAndSubscribe() {
      try {
        addStatus('Initializing BaseDomainController...', 'status');

        // Check if already initialized
        if (BaseDomainController.eventQueue) {
          addStatus('Already initialized!', 'error');
          console.log('Existing eventQueue:', BaseDomainController.eventQueue);
          return;
        }

        // Initialize the static event queue (creates WebsocketProtocolEventQueue but doesn't connect yet)
        eventQueue = BaseDomainController.initialize('ws://localhost:8888');
        console.log('Created eventQueue:', eventQueue);
        console.log('âœ… Controllers available in eventQueue');
        addStatus('Controllers initialized in eventQueue', 'success');

        // Subscribe to Runtime.consoleAPICalled events
        eventQueue.runtimeController.subscribeToEvent(/^Runtime\.consoleAPICalled/, (topic, message) => {
          console.log('ğŸ“¢ Runtime.consoleAPICalled:', message);
          const args = message.params?.args || [];
          const logMessage = args.map(arg => arg.value || arg.description || '').join(' ');
          addEventLog(`${message.params?.type || 'log'}: ${logMessage}`);
        });

        // Subscribe to WebSocket lifecycle events through the queue
        eventQueue.consoleController.subscribeToEvent(/^WebSocket\.open$/, (topic, message) => {
          console.log('âœ… WebSocket.open event');
          addStatus('WebSocket opened - ready to enable Console domain', 'success');
          isInitialized = true;
          document.getElementById('enableBtn').disabled = false;
        });

        eventQueue.consoleController.subscribeToEvent(/^WebSocket\.error$/, (topic, message) => {
          console.error('âŒ WebSocket.error event:', message);
          addStatus('WebSocket error', 'error');
        });

        eventQueue.consoleController.subscribeToEvent(/^WebSocket\.close$/, (topic, message) => {
          console.log('ğŸ”Œ WebSocket.close event');
          addStatus('WebSocket connection closed', 'error');
          isInitialized = false;
          document.getElementById('enableBtn').disabled = true;
        });

        // Connect to WebSocket (creates the ws object and triggers WebSocket.open event)
        addStatus('Connecting to WebSocket...', 'status');
        eventQueue.connect();

        addStatus('Waiting for WebSocket connection...', 'status');
        document.getElementById('initBtn').disabled = true;

      } catch (error) {
        console.error('Initialization failed:', error);
        addStatus('Initialization failed: ' + error.message, 'error');
      }
    }

    // Helper function to add status messages
    function addStatus(message, type = 'status') {
      const container = document.getElementById('status-container');
      const statusDiv = document.createElement('div');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      container.insertBefore(statusDiv, container.firstChild);

      // Keep only last 5 status messages
      while (container.children.length > 5) {
        container.removeChild(container.lastChild);
      }
    }

    // Helper to add event log entries
    function addEventLog(message) {
      eventCount++;
      const logContainer = document.getElementById('event-log');
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.textContent = `[${eventCount}] ${new Date().toLocaleTimeString()}.${new Date().getMilliseconds()} - ${message}`;
      logContainer.insertBefore(logEntry, logContainer.firstChild);

      // Keep only last 20 events
      while (logContainer.children.length > 20) {
        logContainer.removeChild(logContainer.lastChild);
      }
    }



    async function enableConsole() {
      if (!isInitialized) {
        addStatus('WebSocket not connected yet', 'error');
        return;
      }

      try {
        addStatus('Enabling Console domain...', 'status');
        const result = await eventQueue.enable();
        console.log('Enable result:', result);
        addStatus('Console domain enabled - watching for events...', 'success');
        addStatus('Runtime domain enabled - you should see console.log events from busy-script.js', 'success');

        document.getElementById('enableBtn').disabled = true;

      } catch (error) {
        console.error('Error:', error);
        addStatus('Error: ' + error.message, 'error');
      }
    }

    console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Console Event Test - Simplified                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Steps:
  1. Click "Initialize & Subscribe to Console Events"
     - Creates static WebsocketProtocolEventQueue
     - Creates ConsoleController
     - Subscribes to Runtime.consoleAPICalled events

  2. Click "Enable Console Domain"
     - Enables Console domain
     - Enables Runtime domain
     - Starts receiving console.log events from busy-script.js

busy-script.js logs every 10000 iterations, so you should see events
appearing in the log below after step 2.
    `);
  </script>
</body>
</html>