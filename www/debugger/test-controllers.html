<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ UI Controllers Test Page</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: #1e1e1e;
        }

        .test-header {
            background: #2d2d30;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #007acc;
            margin-bottom: 20px;
        }

        .test-header h1 {
            margin: 0 0 10px 0;
            color: #4ec9b0;
        }

        .test-header p {
            margin: 0;
            color: #858585;
            font-size: 14px;
        }

        .test-section {
            margin: 20px;
            padding: 20px;
            background: #252526;
            border-radius: 8px;
            border: 1px solid #3e3e42;
        }

        .test-section h2 {
            margin: 0 0 15px 0;
            color: #569cd6;
            font-size: 18px;
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 10px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .test-panel {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 15px;
            min-height: 250px;
        }

        .test-panel h3 {
            margin: 0 0 10px 0;
            color: #dcdcaa;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .test-panel.wide {
            grid-column: span 2;
        }

        .test-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #3e3e42;
        }

        .test-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .test-btn:hover {
            background: #1177bb;
        }

        .test-btn.secondary {
            background: #3e3e42;
        }

        .test-btn.secondary:hover {
            background: #4e4e52;
        }

        .test-btn.success {
            background: #16825d;
        }

        .test-btn.success:hover {
            background: #1e9b6f;
        }

        .status-bar {
            background: #007acc;
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .component-container {
            height: 100%;
            min-height: 200px;
        }

        /* Make toolbar relative for test layout */
        .toolbar {
            position: relative !important;
            margin-bottom: 15px;
        }

        /* Adjust content for test layout */
        .content {
            position: relative !important;
            margin: 0 !important;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>üß™ UI Controllers Test Page</h1>
        <p>Testing refactored controllers with full debugger functionality</p>
    </div>

    <!-- Connection & Toolbar Test -->
    <div class="test-section">
        <h2>üîå Connection & Toolbar</h2>
        <div class="test-panel wide">
            <h3>Toolbar with Connection Controls</h3>

            <!-- Compact Dockable Toolbar -->
            <div class="toolbar" id="toolbar" data-icon-size="medium">
                <div class="toolbar-grip" id="toolbar-grip" title="Drag to dock">‚ãÆ‚ãÆ</div>

                <!-- Connection Controls -->
                <div id="toolbar-connection-controls" class="toolbar-group">
                    <input type="text" id="toolbar-ws-url" class="toolbar-input" value="ws://localhost:8888" placeholder="ws://localhost:8888" title="WebSocket URL">
                    <button class="toolbar-btn success" id="toolbar-connect-btn">
                        <span class="btn-icon">üîå</span>
                        <span class="btn-label">Connect</span>
                    </button>
                </div>

                <!-- Debug Controls -->
                <div id="toolbar-debug-controls" class="toolbar-group" style="display: none;">
                    <button class="toolbar-btn" id="toolbar-pause-btn">
                        <span class="btn-icon">‚è∏</span>
                        <span class="btn-label">Pause</span>
                    </button>
                    <button class="toolbar-btn" id="toolbar-resume-btn" disabled>
                        <span class="btn-icon">‚ñ∂</span>
                        <span class="btn-label">Resume</span>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button class="toolbar-btn" id="toolbar-step-over-btn" disabled>
                        <span class="btn-icon">‚§µ</span>
                        <span class="btn-label">Over</span>
                    </button>
                    <button class="toolbar-btn" id="toolbar-step-into-btn" disabled>
                        <span class="btn-icon">‚§ì</span>
                        <span class="btn-label">Into</span>
                    </button>
                    <button class="toolbar-btn" id="toolbar-step-out-btn" disabled>
                        <span class="btn-icon">‚§í</span>
                        <span class="btn-label">Out</span>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button class="toolbar-btn danger" id="toolbar-disconnect-btn">
                        <span class="btn-icon">‚úó</span>
                        <span class="btn-label">Disconnect</span>
                    </button>
                </div>

                <!-- Settings Controls -->
                <div class="toolbar-group toolbar-settings">
                    <div class="toolbar-divider"></div>
                    <button class="toolbar-btn small" id="toolbar-settings-btn" title="Settings">
                        <span class="btn-icon">‚öôÔ∏è</span>
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="settings-panel" id="toolbar-settings-panel" style="display: none;">
                <div class="settings-header">Icon Size</div>
                <div class="settings-options">
                    <button class="settings-option-btn" id="toolbar-icon-size-small" data-size="small">
                        <span class="btn-icon">S</span>
                        <span class="btn-label">Small</span>
                    </button>
                    <button class="settings-option-btn" id="toolbar-icon-size-medium" data-size="medium">
                        <span class="btn-icon">M</span>
                        <span class="btn-label">Medium</span>
                    </button>
                    <button class="settings-option-btn" id="toolbar-icon-size-large" data-size="large">
                        <span class="btn-icon">L</span>
                        <span class="btn-label">Large</span>
                    </button>
                </div>
            </div>

            <div class="status-bar" id="status-bar">
                Status: <span id="connection-status">Disconnected</span>
            </div>
        </div>
    </div>

    <!-- Controllers Grid -->
    <div class="test-section">
        <h2>üéõÔ∏è UI Controllers</h2>
        <div class="test-grid">
            <!-- Console Controller -->
            <div class="test-panel">
                <h3>üìú Console Controller</h3>
                <div class="component-container">
                    <div class="tab-pane active" id="console-tab-pane">
                        <div class="console-container" style="display: flex">
                            <div class="console-controls">
                                <button class="console-control-btn" id="console-undock-btn" title="Undock console">‚á±</button>
                            </div>
                            <div id="console-log" class="console-content">
                                <div class="empty-state">No console output</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Call Stack Controller -->
            <div class="test-panel">
                <h3>üìö Call Stack Controller</h3>
                <div class="component-container">
                    <div id="callstack">
                        <div class="empty-state">Pause execution to see call stack</div>
                    </div>
                </div>
            </div>

            <!-- Breakpoints Controller -->
            <div class="test-panel">
                <h3>üî¥ Breakpoint Controller</h3>
                <div class="component-container">
                    <div id="breakpoints-list">
                        <div class="empty-state">No breakpoints set</div>
                    </div>
                    <div class="add-breakpoint-form">
                        <input type="text" class="add-bp-input" id="breakpoints-url" placeholder="File URL or path">
                        <input type="number" class="add-bp-input" id="breakpoints-line" placeholder="Line #" min="1">
                        <button class="add-bp-btn" id="breakpoints-add-btn">Add</button>
                    </div>
                </div>
            </div>

            <!-- File Tree Controller -->
            <div class="test-panel">
                <h3>üìÅ File Tree Controller</h3>
                <div class="component-container">
                    <div class="tree-view">
                        <div class="tree-node expanded">
                            <div class="tree-node-header" onclick="toggleTreeNode(this)">
                                <span class="tree-icon">‚ñº</span>
                                <span class="tree-label">üìÅ Project Files</span>
                            </div>
                            <div class="tree-children" id="projectFiles">
                                <div class="empty-state">No scripts loaded</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scope Variables -->
            <div class="test-panel">
                <h3>üîç Scope Variables</h3>
                <div class="component-container">
                    <div id="scopeVariables">
                        <div class="empty-state">No scope information available</div>
                    </div>
                </div>
            </div>

            <!-- Watches -->
            <div class="test-panel">
                <h3>üëÅÔ∏è Watch Expressions</h3>
                <div class="component-container">
                    <div id="watchExpressions">
                        <div class="empty-state">No watch expressions</div>
                    </div>
                    <div class="add-breakpoint-form">
                        <input type="text" class="add-bp-input" id="watch-expression" placeholder="Expression to watch">
                        <button class="add-bp-btn" id="add-watch-btn">Add</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Actions -->
        <div class="test-actions">
            <button class="test-btn success" onclick="simulateConnection()">üîå Simulate Connection</button>
            <button class="test-btn" onclick="simulateScriptLoad()">üìú Simulate Script Loaded</button>
            <button class="test-btn" onclick="simulatePause()">‚è∏ Simulate Pause</button>
            <button class="test-btn" onclick="simulateBreakpoint()">üî¥ Add Test Breakpoint</button>
            <button class="test-btn" onclick="simulateLogs()">üìù Generate Logs</button>
            <button class="test-btn secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
        </div>
    </div>

    <!-- Console Dock (for undocked console) -->
    <div class="console-dock docked" id="console-dock" style="display: none;">
        <div class="console-dock-header" id="console-dock-grip">
            <span class="console-dock-title">üìú Console</span>
            <div class="console-dock-controls">
                <button class="console-dock-btn" id="console-redock-btn" title="Re-dock to tab panel">‚á≤</button>
            </div>
        </div>
        <div id="console-log-dock" class="console-dock-content">
            <div class="empty-state">No console output</div>
        </div>
    </div>

    <!-- Load jQuery and jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <!-- Load client libraries -->
    <script src="../client/inspector-constants.js"></script>
    <script src="../client/regex-pubsub.js"></script>
    <script src="../client/inspector-browser-proxy.js"></script>
    <script src="../client/inspector-controllers.js"></script>
    <script src="../client/inspector-factory.js"></script>

    <!-- Load utils -->
    <script src="./utils.js"></script>

    <!-- Main application -->
    <script type="module">
        import {
            ToolbarUIController,
            ConsoleUIController,
            CallStackUIController,
            FileTreeUIController,
            BreakpointUIController,
            DebuggerUIController
        } from './controllers.js';

        // Create a simplified DebuggerUI for testing
        class TestDebuggerUI {
            constructor() {
                // Initialize controllers
                this.toolbarController = new ToolbarUIController({
                    debuggerUI: this,
                    instanceId: 'toolbar',
                    skipRender: true
                });

                this.consoleController = new ConsoleUIController({
                    debuggerUI: this,
                    instanceId: 'console',
                    skipRender: true
                });

                this.callStackController = new CallStackUIController({
                    debuggerUI: this,
                    instanceId: 'callstack',
                    skipRender: true
                });

                this.fileTreeController = new FileTreeUIController(this);

                this.breakpointController = new BreakpointUIController({
                    debuggerUI: this,
                    instanceId: 'breakpoints',
                    skipRender: true
                });

                this.debuggerController = new DebuggerUIController(this);
            }

            async initialize() {
                console.log('üöÄ Initializing controllers...');

                this.toolbarController.initialize();
                this.consoleController.initialize();
                this.callStackController.initialize();
                await this.fileTreeController.initialize();
                this.breakpointController.initialize();
                this.debuggerController.initialize();

                console.log('‚úÖ All controllers initialized!');
                log('Test page loaded - controllers ready', 'info');
            }
        }

        // Global test UI instance
        window.testUI = new TestDebuggerUI();

        // Initialize on load
        $(document).ready(async function() {
            await window.testUI.initialize();
            updateStatus('Ready - Click "Simulate Connection" to test', 'info');
        });

        // Simulation functions
        window.simulateConnection = function() {
            log('üîå Simulating connection...', 'info');
            $('#toolbar-connection-controls').hide();
            $('#toolbar-debug-controls').show();
            updateStatus('Connected (simulated)', 'success');
            log('Connected to ws://localhost:8888 (simulated)', 'event');
        };

        window.simulateScriptLoad = function() {
            log('üìú Simulating script load...', 'info');

            // Add some mock scripts via file tree controller
            const scripts = [
                { scriptId: 's1', url: 'file:///home/project/app.js' },
                { scriptId: 's2', url: 'file:///home/project/server.js' },
                { scriptId: 's3', url: 'file:///home/project/utils.js' },
                { scriptId: 's4', url: 'file:///node_modules/express/index.js' }
            ];

            scripts.forEach(script => {
                window.testUI.fileTreeController.addScriptToFileTree(script.scriptId, script.url);
            });

            $('#projectFiles .empty-state').remove();
            log(`Loaded ${scripts.length} scripts`, 'event');
        };

        window.simulatePause = function() {
            log('‚è∏ Simulating pause at breakpoint...', 'event');

            // Enable step buttons
            $('#toolbar-resume-btn, #toolbar-step-over-btn, #toolbar-step-into-btn, #toolbar-step-out-btn').prop('disabled', false);

            // Render mock call stack
            const mockFrames = [
                {
                    functionName: 'handleRequest',
                    url: 'file:///home/project/app.js',
                    location: { lineNumber: 42, columnNumber: 10, scriptId: 's1' },
                    scopeChain: []
                },
                {
                    functionName: 'processData',
                    url: 'file:///home/project/utils.js',
                    location: { lineNumber: 15, columnNumber: 5, scriptId: 's3' },
                    scopeChain: []
                }
            ];

            window.testUI.callStackController.renderCallStack(mockFrames);
            updateStatus('Paused at breakpoint', 'warning');
            log('Execution paused at app.js:42', 'event');

            // Add mock scope variables
            const $scope = $('#scopeVariables');
            $scope.html(`
                <div style="margin-top: 8px; color: var(--text-secondary); font-weight: 600; font-size: var(--font-xs);">LOCAL</div>
                <div class="variable-item">
                    <span class="variable-name">userId:</span>
                    <span class="variable-value">12345</span>
                </div>
                <div class="variable-item">
                    <span class="variable-name">data:</span>
                    <span class="variable-value">{name: "Test"}</span>
                </div>
                <div style="margin-top: 8px; color: var(--text-secondary); font-weight: 600; font-size: var(--font-xs);">CLOSURE</div>
                <div class="variable-item">
                    <span class="variable-name">config:</span>
                    <span class="variable-value">{port: 3000}</span>
                </div>
            `);
        };

        window.simulateBreakpoint = function() {
            // Use the real controller to add a breakpoint
            const url = 'file:///home/project/app.js';
            const line = Math.floor(Math.random() * 100) + 1;

            log(`Adding breakpoint at ${url}:${line}`, 'info');

            // Manually add to the UI since we're not connected
            const $list = $('#breakpoints-list');
            $list.find('.empty-state').remove();

            const bpHtml = `
                <div class="breakpoint-item enabled" data-breakpoint-id="bp-${Date.now()}">
                    <input type="checkbox" class="bp-toggle" checked>
                    <div class="bp-info">
                        <div class="bp-location" title="${url}">app.js:${line}</div>
                    </div>
                    <button class="bp-remove-btn" title="Remove breakpoint">√ó</button>
                </div>
            `;
            $list.append(bpHtml);
        };

        window.simulateLogs = function() {
            const messages = [
                { msg: 'Application started on port 3000', type: 'info' },
                { msg: 'GET /api/users - 200 OK', type: 'event' },
                { msg: 'POST /api/users - 201 Created', type: 'event' },
                { msg: 'Warning: Deprecated API usage detected', type: 'error' },
                { msg: 'Database connection established', type: 'info' },
                { msg: 'Cache hit for user:12345', type: 'event' }
            ];

            messages.forEach(m => {
                log(m.msg, m.type);
            });
        };

        window.clearAll = function() {
            $('#callstack').html('<div class="empty-state">Pause execution to see call stack</div>');
            $('#breakpoints-list').html('<div class="empty-state">No breakpoints set</div>');
            $('#projectFiles').html('<div class="empty-state">No scripts loaded</div>');
            $('#scopeVariables').html('<div class="empty-state">No scope information available</div>');
            $('#console-log').html('<div class="empty-state">No console output</div>');
            $('#console-log-dock').html('<div class="empty-state">No console output</div>');

            $('#toolbar-connection-controls').show();
            $('#toolbar-debug-controls').hide();
            $('#toolbar-resume-btn, #toolbar-step-over-btn, #toolbar-step-into-btn, #toolbar-step-out-btn').prop('disabled', true);

            updateStatus('Cleared - Ready for testing', 'info');
        };

        function updateStatus(message, type) {
            const $status = $('#connection-status');
            $status.text(message);

            const $bar = $('#status-bar');
            $bar.removeClass('info success warning error');

            if (type === 'success') {
                $bar.css('background', '#16825d');
            } else if (type === 'warning') {
                $bar.css('background', '#c19c00');
            } else if (type === 'error') {
                $bar.css('background', '#c74e39');
            } else {
                $bar.css('background', '#007acc');
            }
        }

        console.log('üß™ Test page script loaded');
    </script>
</body>
</html>