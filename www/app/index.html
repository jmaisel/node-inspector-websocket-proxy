<!DOCTYPE html>
<html>
<head>
    <title>Interactive Layout</title>

    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' file: data:; connect-src 'self' ws://localhost:* ws://127.0.0.1:* wss://localhost:* wss://127.0.0.1:*;">

    <link rel="stylesheet" href="/vendor/jquery/jquery-ui.css"/>
    <link rel="stylesheet" href="/app/styles.css"/>
    <link rel="stylesheet" href="/breadboard/pin-manager.css"/>
    <link rel="stylesheet" href="/console/console.css"/>

    <script src="/util/logger.js"></script>

    <script src="/vendor/jquery/jquery-3.5.1.min.js"></script>
    <script src="/vendor/jquery/jquery-ui.js"></script>

    <script src="/vendor/splitjs/split.min.js"></script>

    <script src="/vendor/snap/dist/snap.svg-min.js"></script>

<!--    <script src="/lib/tabbyjs/js/tabby.js"></script>-->

    <!-- breadboard -->
    <script src="/breadboard/breadboard.js"></script>
    <script src="/breadboard/overlay.js"></script>
    <script src="/breadboard/tutorial-strategy.js"></script>
    <script src="/breadboard/line-item.js"></script>
    <script src="/breadboard/bill-of-materials.js"></script>
    <script src="/breadboard/circuit-scanner.js"></script>
    <script src="/breadboard/circuit-model.js"></script>
    <script src="/breadboard/pin-manager-util.js"></script>
    <script src="/breadboard/pin-manager-view.js"></script>
    <script src="/breadboard/pin-manager.js"></script>
    <script src="/breadboard/build-instructions-generator.js"></script>

    <!-- draggable bom -->
    <script src="/util/draggable-window.js"></script>
    <!-- end breadboard -->

    <!-- debugger API client -->
    <script src="/debugger/api/debugger-api-client.js"></script>

    <!-- ace editor helpers -->
    <script src="/editor/project-helper.js"></script>
    <script src="/debugger/api/debugger-connection-helper.js"></script>
    <script src="/debugger/api/debugger-event-helper.js"></script>
    <script src="/debugger/api/debugger-simulator-sync.js"></script>
    <script src="/editor/editor-helper.js"></script>
    <script src="/editor/toolbar-helper.js"></script>
    <script src="/debugger/api/debug-toolbar-helper.js"></script>
    <script src="/editor/ace-tab-manager.js"></script>

    <!-- ace editor controller - NEW VERSION -->
    <script type="module" src="/editor/ace-controller-v2.js"></script>

    <!-- project manager -->
    <script src="/project-ui/project-manager.js"></script>
    <script src="/project-ui/project-ui-controller.js"></script>

    <!-- console -->
    <script src="/console/console-model.js"></script>
    <script src="/console/console-view.js"></script>
    <script src="/console/console-controller.js"></script>
    <!-- end console -->

    <!-- GPIO WebSocket Client -->
    <script src="/gpio/gpio-websocket-client.js"></script>

    <script src="/app/main.js"></script>
</head>

<body>
    <div class="header">
        <div id="dbts-menu">
            <span class="dbts-btn" cmd="design">Design</span>
            <span class="dbts-btn" cmd="build">Build</span>
            <span class="dbts-btn" cmd="test">Test</span>
            <span class="dbts-btn" cmd="share">Share</span>
        </div>
    </div>

    <div class="container">
        <div class="pane" id="west-pane">
            <!-- Editor menubar -->
            <div class="editor-menubar"></div>

            <div id="code-workspace">
                <div id="code-editor-container">
                    <div id="file-tree-panel" class="file-tree-panel">
                        <div class="file-tree-header">
                            <span class="file-tree-title">Files</span>
                            <button id="toggle-filetree" class="file-tree-toggle" title="Toggle File Panel">◀</button>
                        </div>
                        <div id="project-toolbar" class="project-toolbar">
                            <button id="project-new-btn" class="project-btn" title="New Project">New</button>
                            <button id="project-open-btn" class="project-btn" title="Open Project">Open</button>
                            <button id="project-save-btn" class="project-btn" title="Save Project">Save</button>
                            <div class="project-toolbar-separator"></div>
                            <button id="project-export-btn" class="project-btn" title="Export Project">Export</button>
                            <button id="project-import-btn" class="project-btn" title="Import Project">Import</button>
                        </div>
                        <div id="file-tree" class="file-tree-content">
                            <!-- File tree will be populated here -->
                            <div class="file-tree-placeholder">No files loaded</div>
                        </div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <div id="editor-tabs" class="editor-tabs">
                            <!-- Tabs will be dynamically added here -->
                        </div>
                        <iframe id="code" src="/editor/ace.html"></iframe>
                    </div>
                </div>
                <div id="console-panel" class="console-panel">
                    <!-- Tabs - hidden by default, shown after proxy ready -->
                    <div id="console-tabs" class="console-tabs" style="display: none;">
                        <div class="console-tab active" data-tab="console">Console</div>
                        <div class="console-tab" data-tab="breakpoints">Breakpoints</div>
                        <div class="console-tab" data-tab="watches">Watches</div>
                        <div class="console-tab" data-tab="scopes">Scopes</div>
                    </div>

                    <!-- Console Tab Content -->
                    <div id="console-tab-content" class="console-tab-content active" data-tab-content="console">
                        <div id="console-toolbar" class="console-toolbar">
                            <div class="console-btn-group">
                                <button class="console-level-btn active" data-level="DEBUG">DEBUG</button>
                                <button class="console-level-btn active" data-level="INFO">INFO</button>
                                <button class="console-level-btn active" data-level="WARN">WARN</button>
                                <button class="console-level-btn active" data-level="ERROR">ERROR</button>
                                <button class="console-level-btn active" data-level="EVENT">EVENTS</button>
                            </div>
                            <div class="console-search-group">
                                <input type="text" id="console-search" placeholder="Filter messages...">
                            </div>
                            <div class="console-action-group">
                                <button id="console-clear-btn">Clear</button>
                                <button id="console-detach-btn">Detach</button>
                            </div>
                            <button id="console-collapse-btn">▼</button>
                        </div>
                        <div id="console-content" class="console-content">
                            <!-- Console messages will appear here -->
                        </div>
                    </div>

                    <!-- Breakpoints Tab Content -->
                    <div id="breakpoints-tab-content" class="console-tab-content" data-tab-content="breakpoints">
                        <div class="breakpoints-toolbar">
                            <button id="toggle-all-breakpoints-btn" class="breakpoints-toggle-all" title="Enable/Disable all breakpoints">
                                <span class="toggle-icon">✓</span> All Active
                            </button>
                        </div>
                        <div class="breakpoints-empty">No breakpoints set</div>
                        <ul id="breakpoints-list"></ul>
                    </div>

                    <!-- Watches Tab Content -->
                    <div id="watches-tab-content" class="console-tab-content" data-tab-content="watches">
                        <div class="tab-placeholder">Watches coming soon...</div>
                    </div>

                    <!-- Scopes Tab Content -->
                    <div id="scopes-tab-content" class="console-tab-content" data-tab-content="scopes">
                        <div class="tab-placeholder">Scopes coming soon...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pane" id="east-pane">
            <iframe id="circuitFrame" src="/simulator.html?startCircuit=555square.txt"></iframe>
        </div>

        <div id="breadboard-pane">

            <div id="breadboard-container">
                <svg id="breadboard"></svg>
            </div>
            <div id="step-controls">
                <div id="step-content"></div>

                <div id="step-buttons">
                    <img class="gutter-btn" id="backBtn" src="/img/left-chevrons.png" height="35" style="transform: rotate(-90deg)"/>
                    <input type="button"      id="resetBtn"   value="Reset" style="position: relative; bottom: 13px"/>
                    <img class="gutter-btn" id="nextBtn" src="/img/left-chevrons.png" height="35" style="transform: rotate(90deg)"/>
                </div>

            </div>
        </div>

    </div>

    <script>
        // $(function() {
        $(document).ready(function(){
            const logger = new Logger("pithagoras-v2.html");
            $.fn.once = function (type, fn, uid) {

                if(uid === undefined) {
                    logger.error("Called $.once without uid\n", this, "\n", fn);
                }

                let dataStr = type + "-handler-" + uid;

                if(!this.data(dataStr)) {
                    this.data(dataStr, true);
                    this.on(type, fn);
                }
            };

            // File tree toggle functionality
            function resizeAceEditor() {
                const codeFrame = document.getElementById('code');
                if (codeFrame && codeFrame.contentWindow) {
                    try {
                        // Try multiple methods to trigger resize
                        if (codeFrame.contentWindow.editor && typeof codeFrame.contentWindow.editor.resize === 'function') {
                            codeFrame.contentWindow.editor.resize();
                            logger.log('Ace editor resized directly');
                        }
                    } catch (e) {
                        logger.log('Could not resize ace editor:', e);
                    }
                }
            }

            // Use event delegation since the button is rendered dynamically by DebuggerUIApplet
            $(document).on('click', '#toggle-filetree', function() {
                const panel = $('#file-tree-panel');
                const container = $('#code-editor-container');

                // Toggle classes on both elements for synchronized animation
                panel.toggleClass('collapsed');
                container.toggleClass('panel-collapsed');

                // Use transitionend event to know exactly when animation completes
                panel.one('transitionend', function() {
                    resizeAceEditor();
                });

                // Fallback timeout in case transitionend doesn't fire
                setTimeout(resizeAceEditor, 400);
            });

            // this is a hack
            setTimeout(()=>{
                logger.log("================= INITIALIZING PITHAGORAS V2 ==================");

                // Clear any collapsed state
                localStorage.removeItem('console-collapsed');

                let pithagoras = new Pithagoras();
                pithagoras.pageReady();

                // Initialize vertical split for console
                const consoleSplit = Split(['#code-editor-container', '#console-panel'], {
                    direction: 'vertical',
                    sizes: [70, 30],
                    minSize: [200, 150],
                    gutterSize: 8,
                    cursor: 'row-resize',
                    snapOffset: 0,  // Disable snapping
                    dragInterval: 1, // Update every pixel
                    onDragEnd: function(sizes) {
                        // Resize Ace editor after split drag
                        resizeAceEditor();
                        // Store sizes
                        localStorage.setItem('console-split-sizes', JSON.stringify(sizes));
                    }
                });

                // Restore saved split sizes
                const savedSizes = localStorage.getItem('console-split-sizes');
                if (savedSizes) {
                    try {
                        consoleSplit.setSizes(JSON.parse(savedSizes));
                    } catch (e) {
                        logger.error("Failed to restore console split sizes:", e);
                    }
                }

                // Pass split instance to console controller
                if (pithagoras.ctx && pithagoras.ctx.aceController && pithagoras.ctx.aceController.consoleController) {
                    pithagoras.ctx.aceController.consoleController.setConsoleSplit(consoleSplit);
                }

                logger.log("================= DONE INITIALIZING PITHAGORAS V2 ==================");
            }, 1500);
        });
    </script>

    <div id="gutter-buttons" style="position: absolute; z-index: 100; top: 0; left: 0;">
        <table width="70">
            <tr>
                <td colspan="3">
                    <div id="logo-btn-container">
                        <img src="img/jb-logo.png" id="logo-btn"/>
<!--                        <span id="logo-arrow">▼</span>-->
                    </div>
                </td>
            </tr>
            <tr>
                <td align="left"><img id="max-right" class="gutter-btn" src="/img/left-chevrons.png" height="35" style="transform: rotate(-90deg)"></td>
                <td align="center"><img id="return-gutter" class="gutter-btn" src="/img/left-chevrons.png" height="35" style="transform: rotate(180deg)"></td>
                <td align="right"><img id="max-left" class="gutter-btn" src="/img/left-chevrons.png" height="35" style="transform: rotate(90deg)"></td>
            </tr>
        </table>
    </div>

    <div id="pin-manager">
        <div id="pin-manager-view" style="display: flex; width: 100%; height: 100%;">

            <!-- Column for New Content on the Left -->
            <div id="pm-bom" style="flex: 50%; border: 1px solid black; border-radius: 2px;">
                <div class="pm-tip">Select a component to map the simulator pins to the datasheet of the component you are using on the breadboard</div>
                <div class="pm-label">BOM Components</div>
                <div style="display: flex;" id="pm-bom-items">
                    <div class="pm-bom-item">Component</div>
                    <div class="pm-bom-item">Mapped?</div>
                </div>
            </div>

            <!-- Existing BOM List / Component List on the Right -->
            <div id="pm-component-list" style="flex: 50%; border: 1px solid black; border-radius: 2px; margin-left: 5px; margin-right: 5px; height: 100%;">
                <!-- Mapping UI and related functionality -->
                <div id="pm-create-mapping" style="display:none;">
                    <div class="pm-tip">Drag and drop the pins on the IC below so they match the datasheet from the component vendor</div>
                    <div class="pm-label">Logical Pins</div>
                    <div id="pm-logical" style="height: 42px;"></div>
                    <div class="pm-label">Physical Pins</div>
                    <div class="pm-container" id="pm-physical-container" style="margin:5px">
                        <div style="width: 50%; display: table-cell;">
                            <div align="center" style="margin-top: -45px;">

                                <div style="opacity: .5; z-index: 20; position:relative; height: 10px; width: 10px; left: -20px; top: 52px; border-radius: 5px; background: black"></div>
                                <div style="z-index: 21; position:relative; height: 11px; width:20px; top: 23px; background: white; overflow: hidden;"></div>
                                <div style="opacity: .5; z-index: 20; position:relative; height: 20px; width:20px; top: 12px; border-radius: 10px; background: black;"></div>

                                <!-- ic left rail -->
                                <div class="pm-rail pm-droppable-pin" id="left-rail"></div>

                                <!-- virtual IC in the middle -->
                                <div class="pm-center">
                                    <div style="height: 15px"></div>
                                    <div class="pm-chip-manufacturer"></div>
                                    <div style="height: 5px"></div>
                                    <div class="pm-chip-model-nbr"></div>
                                    <div style="height: 5px"></div>
                                    <div class="pm-chip-name"></div>
                                </div>

                                <!-- ic right rail -->
                                <div class="pm-rail pm-droppable-pin" id="right-rail"></div>

                            </div>
                            <div style="display: block; font-size: 10px; text-align: center; margin-bottom: 10px;">
                                <div style="display: inline-block">
                                    <table style="font-size: 11px; width: 95%; border: 1px solid black">
                                        <tr>
                                            <th><label for="pm-manufacturer-name">Manufacturer</label></th>
                                            <th><label for="pm-manufacturer-model-nbr">SKU (Product Nbr)</label></th>
                                        </tr>
                                        <tr>
                                            <td><input style="width: 105px;" type="text" id="pm-manufacturer-name" autocomplete="off"></td>
                                            <td><input style="width: 105px;" type="text" id="pm-manufacturer-model-nbr" autocomplete="off"></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pm-mapping-tip">
                    <p>
                        Select a component from the BOM (Bill Of Materials) at left to define the mapping between logical pins
                        in the simulation and the physical pins that component.
                    </p>

                    <p>
                        In order to build the circuit, you will need to drag and drop the pins to match the pinout in the datasheet.
                    </p>

                    <p>
                        Do this until you have completed (&#x2705;) each item in the BOM.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="bom-inspector"></div>

    <div id="breakpoints-panel" class="debug-panel draggable-window" style="display: none;">
        <div class="draggable-header">
            Breakpoints
            <span class="close-btn">×</span>
        </div>
        <div class="draggable-content debug-panel-content">
            <div id="breakpoints-tabs" class="debug-tabs">
                <div class="debug-tab active" data-tab="breakpoints">Breakpoints</div>
                <div class="debug-tab disabled" data-tab="watches">Watches</div>
                <div class="debug-tab disabled" data-tab="scopes">Scopes</div>
            </div>
            <div id="breakpoints-content" class="debug-tab-content">
                <div class="breakpoints-toolbar">
                    <button id="toggle-all-breakpoints-btn" class="breakpoints-toggle-all" title="Enable/Disable all breakpoints">
                        <span class="toggle-icon">✓</span> All Active
                    </button>
                </div>
                <div class="breakpoints-empty">No breakpoints set</div>
                <ul id="breakpoints-list"></ul>
            </div>
            <div id="watches-content" class="debug-tab-content" style="display: none;">
                Coming soon...
            </div>
            <div id="scopes-content" class="debug-tab-content" style="display: none;">
                Coming soon...
            </div>
        </div>
    </div>
</body>
</html>