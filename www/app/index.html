<!DOCTYPE html>
<html>
<head>
    <title>Joebotics Brometheus</title>

    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' file: data:; connect-src 'self' ws://localhost:* ws://127.0.0.1:* wss://localhost:* wss://127.0.0.1:*;">

    <link rel="stylesheet" href="/vendor/jquery/jquery-ui.css"/>
    <link rel="stylesheet" href="/app/styles.css"/>
    <link rel="stylesheet" href="/breadboard/pin-manager.css"/>
    <link rel="stylesheet" href="/console/console.css"/>

    <!-- Theme System -->
    <link rel="stylesheet" href="/styles/theme-base.css"/>
    <link rel="stylesheet" href="/styles/theme-dark.css"/>
    <link rel="stylesheet" href="/styles/theme-light.css"/>
    <link rel="stylesheet" href="/styles/theme-cinnamon.css"/>
    <link rel="stylesheet" href="/styles/theme-maple-waffles.css"/>
    <link rel="stylesheet" href="/styles/theme-switcher.css"/>
    <link rel="stylesheet" href="/preferences/preferences.css"/>

    <!-- Splash Screen Styles -->
    <style>
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 1.5s ease-out;
        }

        #splash-screen.fade-out {
            opacity: 0;
        }

        .splash-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 60px 80px;
            border-radius: 250px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
            color: #ffffff;
            border: 5px solid rgb(192, 157, 73);
            max-width: 500px;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .splash-logo {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(
                90deg,
                #ff0000,
                #ff4500,
                #ff8c00,
                #ffa500,
                #ffd700,
                #ffff00,
                #ffd700,
                #ffa500,
                #ff8c00,
                #ff4500,
                #ff0000,
                #ff4500,
                #ff8c00,
                #ffa500,
                #ffd700,
                #ffff00
            );
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            animation: fireGradientShift 6s ease-in-out infinite;
        }

        @keyframes fireGradientShift {
            0% {
                background-position: 0% 50%;
                filter: hue-rotate(0deg);
            }
            25% {
                background-position: 50% 50%;
                filter: hue-rotate(15deg);
            }
            50% {
                background-position: 100% 50%;
                filter: hue-rotate(0deg);
            }
            75% {
                background-position: 150% 50%;
                filter: hue-rotate(-15deg);
            }
            100% {
                background-position: 200% 50%;
                filter: hue-rotate(0deg);
            }
        }

        .splash-subtitle {
            font-size: 18px;
            color: #a0a0a0;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .splash-version {
            font-size: 12px;
            color: #666;
            margin-bottom: 30px;
            font-weight: 300;
            font-family: monospace;
        }

        .splash-logo-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .splash-logo-container img {
            position: relative;
            z-index: 2;
        }

        .splash-spinner {
            position: absolute;
            top: 0;
            left: 0;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            z-index: 1;
        }

        .splash-spinner::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #ff0000,
                #ff4500,
                #ff8c00,
                #ffa500,
                #ffd700,
                #ffff00,
                #ffd700,
                #ffa500,
                #ff8c00,
                #ff4500,
                #ff0000
            );
            animation: fireRotate 3s linear infinite;
            mask: radial-gradient(circle, transparent 56px, black 56px);
            -webkit-mask: radial-gradient(circle, transparent 56px, black 56px);
        }

        @keyframes fireRotate {
            to { transform: rotate(360deg); }
        }

        .splash-status {
            margin-top: 20px;
            font-size: 14px;
            color: #a0a0a0;
            min-height: 20px;
            font-weight: 300;
        }
    </style>

    <script src="/util/logger.js"></script>
    <script src="/styles/theme-switcher.js"></script>
    <script src="/preferences/preferences-controller.js"></script>

    <!-- Bluetooth Web Serial API -->
    <script src="/bluetooth/web-serial-manager.js"></script>
    <script src="/bluetooth/bluetooth-ui-controller.js"></script>

    <script src="/vendor/jquery/jquery-3.5.1.min.js"></script>
    <script src="/vendor/jquery/jquery-ui.js"></script>

    <script src="/vendor/splitjs/split.min.js"></script>

    <script src="/vendor/snap/dist/snap.svg-min.js"></script>

    <!-- breadboard -->
    <script src="/breadboard/breadboard.js"></script>
    <script src="/breadboard/overlay.js"></script>
    <script src="/breadboard/tutorial-strategy.js"></script>
    <script src="/breadboard/line-item.js"></script>
    <script src="/breadboard/bill-of-materials.js"></script>
    <script src="/breadboard/circuit-scanner.js"></script>
    <script src="/breadboard/circuit-model.js"></script>
    <script src="/breadboard/pin-manager-util.js"></script>
    <script src="/breadboard/pin-manager-view.js"></script>
    <script src="/breadboard/pin-manager.js"></script>
    <script src="/breadboard/build-instructions-generator.js"></script>

    <!-- draggable bom -->
    <script src="/util/draggable-window.js"></script>
    <!-- end breadboard -->

    <!-- debugger API client -->
    <script src="/debugger/api/debugger-api-client.js"></script>

    <!-- ace editor helpers -->
    <script src="/editor/project-api.js"></script>
    <script src="/editor/project-ui.js"></script>
    <script src="/editor/project-file-tree.js"></script>
    <script src="/editor/project-helper.js"></script>
    <script src="/debugger/api/debugger-connection-helper.js"></script>
    <script src="/debugger/api/debugger-event-helper.js"></script>
    <script src="/debugger/api/debugger-simulator-sync.js"></script>
    <script src="/editor/editor-helper.js"></script>
    <script src="/editor/toolbar-helper.js"></script>
    <script src="/debugger/api/debug-toolbar-helper.js"></script>
    <script src="/editor/ace-tab-manager.js"></script>

    <!-- ace editor controller - NEW VERSION -->
    <script type="module" src="/editor/ace-controller-v2.js"></script>

    <!-- file tree controller -->
    <script src="/editor/file-tree-controller.js"></script>

    <!-- project manager -->
    <script src="/project-ui/project-manager.js"></script>
    <script src="/project-ui/project-ui-controller.js"></script>

    <!-- console -->
    <script src="/console/console-model.js"></script>
    <script src="/console/console-view.js"></script>
    <script src="/console/console-controller.js"></script>
    <!-- end console -->

    <!-- GPIO WebSocket Client -->
    <script src="/gpio/gpio-websocket-client.js"></script>

    <!-- Circuit Menu Builder -->
    <script src="/app/circuit-menu-builder.js"></script>

    <!-- Application modules (extracted from main.js) -->
    <script src="/app/observable-map.js"></script>
    <script src="/app/gutter-controller.js"></script>
    <script src="/app/mode-controller.js"></script>
    <script src="/app/toolbar-controller.js"></script>
    <script src="/app/app-bootstrap.js"></script>
</head>

<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-content">
            <div>Joebotics Presents</div>
            <div class="splash-subtitle" style="font-size:14px; font-style: italic; position: relative; top: 25px; font-weight: bold">The</div>
            <div class="splash-logo">BadgerBox</div>
            <div class="splash-subtitle">AR - Integrated Electronics Development Environment</div>
            <div class="splash-version" id="splash-version">Loading version...</div>
            <div class="splash-logo-container">
                <img src="/img/jb-logo.png" alt="Pithagoras Logo" style="padding-left: -2px; margin-top: -11px; filter: invert(100%)" width="220">
                <div class="splash-spinner"></div>
            </div>
            <div class="splash-status">Initializing...</div>
        </div>
    </div>

    <!-- Unified Toolbar spanning entire application -->
    <div class="unified-app-toolbar">
        <!-- Project section -->
        <div class="toolbar-section">
            <div class="toolbar-dropdown">
                <button class="toolbar-btn toolbar-btn-vertical" id="project-menu-btn">
                    <span class="btn-icon">üìÅ</span>
                    <span class="btn-label">Project ‚ñæ</span>
                </button>
                <div class="toolbar-dropdown-content" id="project-dropdown-content">
                    <div class="menu-item" id="project-new-btn-menu" title="New Project">
                        üìÑ New Project
                    </div>
                    <div class="menu-item" id="project-open-btn-menu" title="Open / Manage Projects">
                        üìÅ Open / Manage Projects
                    </div>
                    <div class="menu-item" id="project-save-btn-menu" title="Save Project">
                        üíæ Save Project
                    </div>
                    <div class="menu-separator"></div>
                    <div class="menu-item" id="project-import-btn-menu" title="Import Project">
                        üì• Import Project
                    </div>
                    <div class="menu-item" id="project-export-btn-menu" title="Export Project">
                        üì§ Export Project
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode section -->
        <div class="toolbar-section">
            <div class="toolbar-dropdown">
                <button class="toolbar-btn toolbar-btn-vertical" id="mode-menu-btn">
                    <span class="btn-icon" style="overflow:hidden"><img alt="joebotics" src="/img/jb-logo.png" style="width: 20px; height: 20px; position:relative; overflow: hidden; filter: invert(100%);"/></span>
                    <span class="btn-label">Mode ‚ñæ</span>
                </button>
                <div class="toolbar-dropdown-content" id="mode-dropdown-content">
                    <div class="menu-item" cmd="design" id="mode-design-btn" title="Design Mode">
                        üé® Design
                    </div>
                    <div class="menu-item" cmd="build" id="mode-build-btn" title="Build Mode">
                        üî® Build
                    </div>
                </div>
            </div>
        </div>

        <!-- Preferences section -->
        <div class="toolbar-section">
            <button class="toolbar-btn toolbar-btn-vertical" id="preferences-btn">
                <span class="btn-icon">‚öôÔ∏è</span>
                <span class="btn-label">Preferences</span>
            </button>
        </div>

        <!-- Bluetooth section -->
        <div class="toolbar-section">
            <button class="toolbar-btn toolbar-btn-vertical" id="bluetooth-toggle-btn">
                <span class="btn-icon">üì°</span>
                <span class="btn-label">Bluetooth</span>
            </button>
        </div>

        <!-- Circuits section -->
        <div class="toolbar-section">
            <div class="toolbar-dropdown">
                <button class="toolbar-btn toolbar-btn-vertical" id="circuits-menu-btn">
                    <span class="btn-icon">‚ö°</span>
                    <span class="btn-label">Circuits ‚ñæ</span>
                </button>
                <div class="toolbar-dropdown-content" id="circuits-dropdown-content">
                    <!-- Will be populated by JavaScript -->
                    <div style="padding: 8px; color: #888;">Loading circuits...</div>
                </div>
            </div>
        </div>

        <div class="toolbar-separator"></div>

        <!-- Debug section -->
        <div class="toolbar-section">
            <button id="debug-start-btn" class="toolbar-btn" title="Start Debugging" disabled>
                <span class="debug-icon">üêû</span>
                <span class="debug-label">Debug</span>
                <div id="debug-filename" class="debug-filename"></div>
            </button>
        </div>

        <!-- Debug controls (hidden until debugging) -->
        <div class="toolbar-separator debug-control-separator" style="display: none;"></div>
        <div class="toolbar-section debug-control" style="display: none;">
            <button id="debug-stop" class="toolbar-btn toolbar-btn-vertical" title="Stop">
                <span class="btn-icon">‚ñ°</span>
                <span class="btn-label">Stop</span>
            </button>
            <button id="debug-continue" class="toolbar-btn toolbar-btn-vertical" title="Resume">
                <span class="btn-icon">‚ñ∑</span>
                <span class="btn-label">Resume</span>
            </button>
            <button id="debug-pause" class="toolbar-btn toolbar-btn-vertical" title="Pause">
                <span class="btn-icon">‚è∏</span>
                <span class="btn-label">Pause</span>
            </button>
            <div class="toolbar-separator"></div>
            <button id="debug-step-over" class="toolbar-btn toolbar-btn-vertical" title="Step Over">
                <span class="btn-icon">‚ñ∑‚ñ∑</span>
                <span class="btn-label">Step Over</span>
            </button>
            <button id="debug-step-into" class="toolbar-btn toolbar-btn-vertical" title="Step Into">
                <span class="btn-icon">‚ñΩ‚ñΩ</span>
                <span class="btn-label">Step Into</span>
            </button>
            <button id="debug-step-out" class="toolbar-btn toolbar-btn-vertical" title="Step Out">
                <span class="btn-icon">‚ñ≥‚ñ≥</span>
                <span class="btn-label">Step Out</span>
            </button>
        </div>

        <!-- Spacer to push fullscreen button to the right -->
        <div style="flex: 1;"></div>

        <!-- Fullscreen button -->
        <div class="toolbar-section">
            <button id="fullscreen-btn" class="toolbar-btn toolbar-btn-vertical" title="Toggle Fullscreen">
                <span class="btn-icon" id="fullscreen-icon">‚õ∂</span>
                <span class="btn-label">Fullscreen</span>
            </button>
        </div>

    </div>

    <!-- Hidden project buttons for maintaining existing functionality -->
    <button id="project-new-btn" style="display: none;" title="New Project"></button>
    <button id="project-open-btn" style="display: none;" title="Open Project"></button>
    <button id="project-save-btn" style="display: none;" title="Save Project"></button>
    <button id="project-import-btn" style="display: none;" title="Import Project"></button>
    <button id="project-export-btn" style="display: none;" title="Export Project"></button>
    <input type="file" id="project-import-file" style="display: none;" accept=".zip">

    <div class="container">
        <div class="pane" id="west-pane">
            <div id="code-workspace">
                <div id="code-editor-container">
                    <div id="file-tree-panel" class="file-tree-panel">
                        <div class="file-tree-header">
                            <input type="text" id="file-tree-search" class="file-tree-search-input" placeholder="Filter files...">
                            <button id="clear-file-search" class="file-tree-clear-btn" title="Clear filter">√ó</button>
                            <button id="toggle-filetree" class="file-tree-toggle" title="Toggle File Panel">‚óÄ</button>
                        </div>
                        <div id="file-tree" class="file-tree-content">
                            <!-- File tree will be populated here -->
                            <div class="file-tree-placeholder">No files loaded</div>
                        </div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <div id="editor-tabs" class="editor-tabs">
                            <!-- Tabs will be dynamically added here -->
                        </div>
                        <iframe id="code" src="/editor/ace.html"></iframe>
                    </div>
                </div>
                <div id="console-panel" class="console-panel">
                    <!-- Tabs - hidden by default, shown after proxy ready -->
                    <div id="console-tabs" class="console-tabs" style="display: none;">
                        <div class="console-tab active" data-tab="console">Console</div>
                        <div class="console-tab" data-tab="breakpoints">Breakpoints</div>
                        <div class="console-tab" data-tab="watches">Watches</div>
                        <div class="console-tab" data-tab="scopes">Scopes</div>
                    </div>

                    <!-- Console Tab Content -->
                    <div id="console-tab-content" class="console-tab-content active" data-tab-content="console">
                        <div id="console-toolbar" class="console-toolbar">
                            <div class="console-btn-group">
                                <button class="console-level-btn active" data-level="DEBUG">DEBUG</button>
                                <button class="console-level-btn active" data-level="INFO">INFO</button>
                                <button class="console-level-btn active" data-level="WARN">WARN</button>
                                <button class="console-level-btn active" data-level="ERROR">ERROR</button>
                                <button class="console-level-btn active" data-level="EVENT">EVENTS</button>
                            </div>
                            <div class="console-search-group">
                                <input type="text" id="console-search" placeholder="Filter messages...">
                            </div>
                            <div class="console-action-group">
                                <button id="console-clear-btn">Clear</button>
                                <button id="console-detach-btn">Detach</button>
                            </div>
                            <button id="console-collapse-btn">‚ñº</button>
                        </div>
                        <div id="console-content" class="console-content">
                            <!-- Console messages will appear here -->
                        </div>
                    </div>

                    <!-- Breakpoints Tab Content -->
                    <div id="breakpoints-tab-content" class="console-tab-content" data-tab-content="breakpoints">
                        <div class="breakpoints-toolbar">
                            <button id="toggle-all-breakpoints-btn" class="breakpoints-toggle-all" title="Enable/Disable all breakpoints">
                                <span class="toggle-icon">‚úì</span> All Active
                            </button>
                        </div>
                        <div class="breakpoints-empty">No breakpoints set</div>
                        <ul id="breakpoints-list"></ul>
                    </div>

                    <!-- Watches Tab Content -->
                    <div id="watches-tab-content" class="console-tab-content" data-tab-content="watches">
                        <div class="tab-placeholder">Watches coming soon...</div>
                    </div>

                    <!-- Scopes Tab Content -->
                    <div id="scopes-tab-content" class="console-tab-content" data-tab-content="scopes">
                        <div class="tab-placeholder">Scopes coming soon...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pane" id="east-pane">
            <iframe id="circuitFrame" src="/simulator.html?startCircuit=555square.txt"></iframe>
        </div>

        <div id="breadboard-pane">

            <div id="breadboard-container">
                <svg id="breadboard"></svg>
            </div>
            <div id="step-controls">
                <div id="step-content"></div>

                <div id="step-buttons">
                    <img class="gutter-btn" id="backBtn" src="/img/left-chevrons.png" height="35" style="transform: rotate(-90deg)"/>
                    <input type="button"      id="resetBtn"   value="Reset" style="position: relative; bottom: 13px"/>
                    <img class="gutter-btn" id="nextBtn" src="/img/left-chevrons.png" height="35" style="transform: rotate(90deg)"/>
                </div>
            </div>
        </div>

        <!-- Bluetooth Dialog (hidden by default) -->
        <div id="bluetooth-dialog" title="Bluetooth Serial Connection" style="display: none;">
            <!-- Bluetooth content will be loaded here -->
        </div>

    </div>

    <script>
        $(document).ready(function(){
            const logger = new Logger("pithagoras-v2.html");

            // jQuery utility for one-time event binding
            $.fn.once = function (type, fn, uid) {
                if(uid === undefined) {
                    logger.error("Called $.once without uid\n", this, "\n", fn);
                }

                let dataStr = type + "-handler-" + uid;

                if(!this.data(dataStr)) {
                    this.data(dataStr, true);
                    this.on(type, fn);
                }
            };

            /**
             * Fetch and display version from package.json
             * Implements timeout and offline detection
             */
            async function loadVersion() {
                const MAX_VERSION_LOAD_TIME = 5000; // 5 seconds max
                const versionEl = document.getElementById('splash-version');

                try {
                    // Race fetch against timeout
                    const fetchPromise = fetch('/package.json').then(r => r.json());
                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('timeout')), MAX_VERSION_LOAD_TIME)
                    );

                    const packageJson = await Promise.race([fetchPromise, timeoutPromise]);
                    const version = packageJson.version || 'unknown';

                    if (versionEl) {
                        versionEl.textContent = version;
                    }
                    logger.log('Version loaded:', version);

                    // Notify Pithagoras: online mode
                    if (window.application?.onVersionLoaded) {
                        window.application.onVersionLoaded(version, true);
                    }
                } catch (error) {
                    // Timeout or network error: offline mode
                    logger.warn('Could not load version (offline mode):', error);

                    if (versionEl) {
                        versionEl.textContent = 'offline mode';
                    }

                    // Notify Pithagoras: offline mode
                    if (window.application?.onVersionLoaded) {
                        window.application.onVersionLoaded('offline mode', false);
                    }
                }
            }

            // Load version immediately
            loadVersion();

            /**
             * Wait for a specific iframe to load and be ready
             * @param {string} selector - jQuery selector for the iframe
             * @param {function} readyCheck - Optional function to check if iframe content is ready
             * @returns {Promise<void>}
             */
            function waitForIframe(selector, readyCheck = null) {
                return new Promise((resolve, reject) => {
                    const iframe = $(selector)[0];

                    if (!iframe) {
                        reject(new Error(`Iframe ${selector} not found`));
                        return;
                    }

                    // Check if already loaded
                    if (iframe.contentWindow && iframe.contentDocument) {
                        if (!readyCheck || readyCheck(iframe)) {
                            logger.log(`Iframe ${selector} already loaded`);
                            resolve();
                            return;
                        }
                    }

                    // Wait for load event
                    $(iframe).on('load', function onLoad() {
                        logger.log(`Iframe ${selector} loaded`);

                        // If there's a ready check, poll until it passes
                        if (readyCheck) {
                            const checkInterval = setInterval(() => {
                                if (readyCheck(iframe)) {
                                    clearInterval(checkInterval);
                                    resolve();
                                }
                            }, 50);

                            // Timeout after 10 seconds
                            setTimeout(() => {
                                clearInterval(checkInterval);
                                logger.warn(`Iframe ${selector} ready check timed out`);
                                resolve(); // Resolve anyway to not block initialization
                            }, 10000);
                        } else {
                            resolve();
                        }
                    });

                    // Timeout fallback
                    setTimeout(() => {
                        logger.warn(`Iframe ${selector} load timeout, proceeding anyway`);
                        resolve();
                    }, 15000);
                });
            }

            /**
             * Wait for all required iframes to be ready
             * @returns {Promise<void>}
             */
            async function waitForIframes() {
                logger.log('Waiting for iframes to load...');

                await Promise.all([
                    // Wait for circuit simulator iframe and CircuitJS1 to be available
                    waitForIframe('#circuitFrame', (iframe) => {
                        return iframe.contentWindow && iframe.contentWindow.CircuitJS1;
                    }),

                    // Wait for code editor iframe
                    waitForIframe('#code', (iframe) => {
                        return iframe.contentWindow && iframe.contentWindow.document;
                    })
                ]);

                logger.log('All iframes ready');
            }

            // Initialize application after iframes are loaded
            (async () => {
                await waitForIframes();

                const pithagoras = new Pithagoras();
                await pithagoras.initialize();

                // Setup Bluetooth dialog
                const bluetoothToggleBtn = document.getElementById('bluetooth-toggle-btn');
                const bluetoothDialog = $('#bluetooth-dialog');

                if (bluetoothToggleBtn && bluetoothDialog.length) {
                    let bluetoothContentLoaded = false;

                    bluetoothToggleBtn.addEventListener('click', async () => {
                        logger.log('Bluetooth button clicked');

                        // Load content if not already loaded
                        if (!bluetoothContentLoaded) {
                            try {
                                const response = await fetch('/bluetooth/bluetooth-panel.html');
                                const html = await response.text();
                                bluetoothDialog.html(html);
                                bluetoothContentLoaded = true;
                                logger.log('Bluetooth panel content loaded');
                            } catch (error) {
                                logger.error('Error loading Bluetooth panel:', error);
                                alert('Failed to load Bluetooth panel');
                                return;
                            }
                        }

                        // Open dialog
                        bluetoothDialog.dialog({
                            modal: true,
                            width: 800,
                            position: { my: "center", at: "center", of: window },
                            open: function() {
                                logger.log('Bluetooth dialog opened');

                                // Initialize Bluetooth controller if not already done
                                if (!window.btController && window.BluetoothUIController) {
                                    window.btController = new BluetoothUIController();
                                    window.btController.initialize();
                                    logger.log('Bluetooth controller initialized');

                                    // Setup clear terminal button
                                    const clearBtn = document.getElementById('bt-clear-terminal');
                                    if (clearBtn) {
                                        clearBtn.addEventListener('click', () => {
                                            window.btController.clearTerminal();
                                        });
                                    }
                                }
                            },
                            close: function() {
                                logger.log('Bluetooth dialog closed');
                            }
                        });
                    });

                    logger.log('Bluetooth toggle button initialized');
                } else {
                    logger.error('Bluetooth elements not found!', {
                        buttonFound: !!bluetoothToggleBtn,
                        dialogFound: bluetoothDialog.length > 0
                    });
                }
            })();
        });
    </script>

    <div id="gutter-buttons" style="position: absolute; z-index: 100; margin-top: -30px; margin-left:2px">
        <table width="70">
            <tr>
                <td align="left"><img id="max-right" class="gutter-btn" src="/img/left-chevrons.png" height="25" style="transform: rotate(-90deg)"></td>
                <td align="center"><img id="return-gutter" class="gutter-btn" src="/img/left-chevrons.png" width="13" height="23" style="transform: rotate(180deg)"></td>
                <td align="right"><img id="max-left" class="gutter-btn" src="/img/left-chevrons.png" height="25" style="transform: rotate(90deg)"></td>
            </tr>
        </table>
    </div>

    <div id="pin-manager">
        <div id="pin-manager-view" style="display: flex; width: 100%; height: 100%;">

            <!-- Column for New Content on the Left -->
            <div id="pm-bom" style="flex: 50%; border: 1px solid black; border-radius: 2px;">
                <div class="pm-tip">Select a component to map the simulator pins to the datasheet of the component you are using on the breadboard</div>
                <div class="pm-label">BOM Components</div>
                <div style="display: flex;" id="pm-bom-items">
                    <div class="pm-bom-item">Component</div>
                    <div class="pm-bom-item">Mapped?</div>
                </div>
            </div>

            <!-- Existing BOM List / Component List on the Right -->
            <div id="pm-component-list" style="flex: 50%; border: 1px solid black; border-radius: 2px; margin-left: 5px; margin-right: 5px; height: 100%;">
                <!-- Mapping UI and related functionality -->
                <div id="pm-create-mapping" style="display:none;">
                    <div class="pm-tip">Drag and drop the pins on the IC below so they match the datasheet from the component vendor</div>
                    <div class="pm-label">Logical Pins</div>
                    <div id="pm-logical" style="height: 42px;"></div>
                    <div class="pm-label">Physical Pins</div>
                    <div class="pm-container" id="pm-physical-container" style="margin:5px">
                        <div style="width: 50%; display: table-cell;">
                            <div align="center" style="margin-top: -45px;">

                                <div style="opacity: .5; z-index: 20; position:relative; height: 10px; width: 10px; left: -20px; top: 52px; border-radius: 5px; background: black"></div>
                                <div style="z-index: 21; position:relative; height: 11px; width:20px; top: 23px; background: white; overflow: hidden;"></div>
                                <div style="opacity: .5; z-index: 20; position:relative; height: 20px; width:20px; top: 12px; border-radius: 10px; background: black;"></div>

                                <!-- ic left rail -->
                                <div class="pm-rail pm-droppable-pin" id="left-rail"></div>

                                <!-- virtual IC in the middle -->
                                <div class="pm-center">
                                    <div style="height: 15px"></div>
                                    <div class="pm-chip-manufacturer"></div>
                                    <div style="height: 5px"></div>
                                    <div class="pm-chip-model-nbr"></div>
                                    <div style="height: 5px"></div>
                                    <div class="pm-chip-name"></div>
                                </div>

                                <!-- ic right rail -->
                                <div class="pm-rail pm-droppable-pin" id="right-rail"></div>

                            </div>
                            <div style="display: block; font-size: 10px; text-align: center; margin-bottom: 10px;">
                                <div style="display: inline-block">
                                    <table style="font-size: 11px; width: 95%; border: 1px solid black">
                                        <tr>
                                            <th><label for="pm-manufacturer-name">Manufacturer</label></th>
                                            <th><label for="pm-manufacturer-model-nbr">SKU (Product Nbr)</label></th>
                                        </tr>
                                        <tr>
                                            <td><input style="width: 105px;" type="text" id="pm-manufacturer-name" autocomplete="off"></td>
                                            <td><input style="width: 105px;" type="text" id="pm-manufacturer-model-nbr" autocomplete="off"></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pm-mapping-tip">
                    <p>
                        Select a component from the BOM (Bill Of Materials) at left to define the mapping between logical pins
                        in the simulation and the physical pins that component.
                    </p>

                    <p>
                        In order to build the circuit, you will need to drag and drop the pins to match the pinout in the datasheet.
                    </p>

                    <p>
                        Do this until you have completed (&#x2705;) each item in the BOM.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="bom-inspector"></div>

</body>
</html>